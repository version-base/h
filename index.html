<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VersionBase - Game Version Manager</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; padding: 20px; background-color: #f8f9fa; color: #212529; }
        .container { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); max-width: 600px; margin: 30px auto; }
        h2 { color: #0056b3; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; text-align: center;}
        h3, h4 { color: #0056b3; margin-top: 25px; margin-bottom: 15px;}
        h4 { font-size: 1.1em; border-bottom: 1px dotted #ccc; padding-bottom: 5px;}
        .hidden { display: none; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057;}
        input[type="email"], input[type="password"], input[type="text"] { width: calc(100% - 24px); padding: 11px; margin-bottom: 15px; border: 1px solid #ced4da; border-radius: 4px; font-size: 1rem; box-sizing: border-box; }
        input:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        button { background-color: #007bff; color: white; padding: 10px 18px; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px; font-size: 1rem; transition: background-color 0.2s ease, opacity 0.2s ease; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.7;}
        #logoutButton { background-color: #dc3545; }
        #logoutButton:hover:not(:disabled) { background-color: #c82333; }
        #forgotPasswordButton { background-color: #ffc107; color: #212529; }
        #forgotPasswordButton:hover:not(:disabled) { background-color: #e0a800; }
        .status-message { margin-top: 15px; font-weight: 500; padding: 12px; border-radius: 4px; text-align: center; border: 1px solid transparent;}
        .error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb;}
        .success { color: #155724; background-color: #d4edda; border-color: #c3e6cb;}
        .info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb;}
        hr { border: 0; border-top: 1px solid #dee2e6; margin: 30px 0; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        #ownedGamesList { margin-bottom: 15px; padding-left: 0; max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background-color: #ffffff; list-style-type: none;}
        #ownedGamesList li { margin-bottom: 10px; padding: 10px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px;}
        #ownedGamesList li:last-child { border-bottom: none; }
        #ownedGamesList li > div { flex-grow: 1; }
        #ownedGamesList code { font-size: 1.1em; color: #333; background-color: transparent; padding: 0; }
        #ownedGamesList small { display: block; font-size: 0.85em; color: #6c757d; margin-top: 3px; }
        .select-game-btn { font-size: 0.8em; padding: 4px 10px; background-color: #28a745; flex-shrink: 0;}
        .select-game-btn:hover:not(:disabled) { background-color: #218838; }
    </style>
</head>
<body>

<div class="container">
    <h2>VersionBase: Game Version Management</h2>

    <div id="authSection">
        <h3>Account Access</h3>
        <div id="loginForm">
            <label for="email">Email:</label>
            <input type="email" id="email" required autocomplete="email" placeholder="your@email.com">
            <label for="password">Password:</label>
            <input type="password" id="password" required autocomplete="current-password" placeholder="Enter your password">
            <label for="confirmPassword" class="hidden" id="confirmPasswordLabel">Confirm Password:</label>
            <input type="password" class="hidden" id="confirmPassword" required autocomplete="new-password" placeholder="Re-enter password for signup">
            <button id="loginButton">Login</button>
            <button id="signupButton" class="hidden">Sign Up</button>
            <button id="forgotPasswordButton">Forgot Password?</button>
            <p style="margin-top:15px;"><a href="#" id="toggleSignup" role="button">Need an account? Sign Up</a></p>
        </div>
        <div id="loggedInStatus" class="hidden">
            <p>Logged in as: <strong id="userEmail"></strong></p>
            <button id="logoutButton">Logout</button>
        </div>
        <div id="authStatus" class="status-message hidden" role="alert"></div>
    </div>

    <hr>

    <div id="gameManagementSection" class="hidden">
        <h3>Manage Your Games</h3>
        <div id="ownedGamesSection">
             <h4>Your Registered Games (<span id="ownedGamesCount">0</span>)</h4>
             <div id="ownedGamesList" aria-live="polite"><p><i>Loading...</i></p></div>
             <div id="selectGameStatus" class="status-message hidden" role="status"></div>
        </div>
        <div id="registrationSection">
            <h4>Register a New Game</h4>
            <p>Claim a unique Roblox Game ID to start managing its version.</p>
            <label for="registerGameId">Roblox Game ID (Numbers Only):</label>
            <input type="text" id="registerGameId" inputmode="numeric" pattern="[0-9]+" placeholder="e.g., 9876543210" required>
            <button id="registerButton">Register This ID</button>
            <div id="registerStatus" class="status-message hidden" role="alert"></div>
        </div>
        <hr style="margin: 25px 0;">
        <div id="updateSection">
             <h4>Update Game Version</h4>
             <p>Select from your list above or enter your Game ID, then provide the new version.</p>
             <label for="updateGameId">Game ID to Update:</label>
             <input type="text" id="updateGameId" inputmode="numeric" pattern="[0-9]+" placeholder="Select or enter owned numeric ID" required>
             <label for="newVersion">New Version String:</label>
             <input type="text" id="newVersion" required placeholder="e.g., 1.1.0 or 0.9 Release">
             <button id="updateButton">Set New Version</button>
             <div id="updateStatus" class="status-message hidden" role="alert"></div>
        </div>
    </div>

     <hr>
     <p style="text-align: center;">Access the public version data via the <a href="api.html" target="_blank" rel="noopener noreferrer">VersionBase Public API</a>.</p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
  import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      sendPasswordResetEmail,
      onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
  import {
      getDatabase,
      ref,
      set,
      get,
      child,
      runTransaction,
      query,
      orderByChild,
      equalTo
  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDH_FPy4OL9HsidTrmpnO-ediDfHNzgQPw",
    authDomain: "starthed3v.firebaseapp.com",
    databaseURL: "https://starthed3v-default-rtdb.firebaseio.com",
    projectId: "starthed3v",
    storageBucket: "starthed3v.appspot.com",
    messagingSenderId: "869533398876",
    appId: "1:869533398876:web:b7df79fb6eaeb5b481b399",
    measurementId: "G-862TWDHWCL"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const gamesRef = ref(db, 'games');

  const loginForm = document.getElementById('loginForm');
  const loggedInStatus = document.getElementById('loggedInStatus');
  const userEmailSpan = document.getElementById('userEmail');
  const logoutButton = document.getElementById('logoutButton');
  const authStatus = document.getElementById('authStatus');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const confirmPasswordLabel = document.getElementById('confirmPasswordLabel');
  const loginButton = document.getElementById('loginButton');
  const signupButton = document.getElementById('signupButton');
  const forgotPasswordButton = document.getElementById('forgotPasswordButton');
  const toggleSignupLink = document.getElementById('toggleSignup');
  const gameManagementSection = document.getElementById('gameManagementSection');
  const registrationSection = document.getElementById('registrationSection');
  const registerGameIdInput = document.getElementById('registerGameId');
  const registerButton = document.getElementById('registerButton');
  const registerStatus = document.getElementById('registerStatus');
  const ownedGamesSection = document.getElementById('ownedGamesSection');
  const ownedGamesListDiv = document.getElementById('ownedGamesList');
  const ownedGamesCountSpan = document.getElementById('ownedGamesCount');
  const selectGameStatus = document.getElementById('selectGameStatus');
  const updateSection = document.getElementById('updateSection');
  const updateGameIdInput = document.getElementById('updateGameId');
  const newVersionInput = document.getElementById('newVersion');
  const updateButton = document.getElementById('updateButton');
  const updateStatus = document.getElementById('updateStatus');

  let isSignupMode = false;
  const allButtons = document.querySelectorAll('button');

  function showStatus(element, message, type = 'info', duration = 5000) {
      element.textContent = message;
      element.className = `status-message ${type}`;
      element.classList.remove('hidden');
      const effectiveDuration = (type === 'error') ? duration + 3000 : duration;
      if (duration > 0) { setTimeout(() => hideStatus(element), effectiveDuration); }
  }
  function hideStatus(element) { element.classList.add('hidden'); element.textContent = ''; element.className = 'status-message hidden'; }
  function setLoading(button, isLoading, originalText = null) {
      if (isLoading) {
          button.disabled = true;
          if (!button.dataset.originalText) { button.dataset.originalText = button.textContent; }
          button.textContent = 'Processing...';
      } else {
          button.disabled = false;
          button.textContent = button.dataset.originalText || originalText || button.textContent;
          delete button.dataset.originalText;
      }
  }
  function setBulkLoading(isLoading) { allButtons.forEach(btn => { btn.disabled = isLoading; }); }
  function toggleSignupModeUI(showSignup) {
      isSignupMode = showSignup;
      confirmPasswordInput.classList.toggle('hidden', !showSignup);
      confirmPasswordLabel.classList.toggle('hidden', !showSignup);
      loginButton.classList.toggle('hidden', showSignup);
      forgotPasswordButton.classList.toggle('hidden', showSignup);
      signupButton.classList.toggle('hidden', !showSignup);
      toggleSignupLink.textContent = showSignup ? 'Already have an account? Login.' : 'Need an account? Sign Up';
      hideStatus(authStatus);
  }
  function getAuthErrorMessage(error) {
        switch (error.code) {
            case 'auth/invalid-email': return 'Invalid email format.';
            case 'auth/user-disabled': return 'Account disabled.';
            case 'auth/user-not-found': return 'No account found.';
            case 'auth/invalid-credential': return 'Incorrect email or password.';
            case 'auth/wrong-password': return 'Incorrect password.';
            case 'auth/email-already-in-use': return 'Email already registered.';
            case 'auth/weak-password': return 'Password too weak (min 6 chars).';
            case 'auth/requires-recent-login': return 'Requires recent login. Log out/in.';
            case 'auth/too-many-requests': return 'Too many attempts. Try later.';
            default: return `Auth error (${error.code}).`;
        }
    }
  function clearAuthInputs() { emailInput.value = ''; passwordInput.value = ''; confirmPasswordInput.value = ''; }
  function clearRegisterForm() { registerGameIdInput.value = ''; }
  function clearUpdateForm() { updateGameIdInput.value = ''; newVersionInput.value = '';}
  function clearAllStatus() { hideStatus(authStatus); hideStatus(registerStatus); hideStatus(updateStatus); hideStatus(selectGameStatus); }

  onAuthStateChanged(auth, (user) => {
    clearAllStatus();
    const loggedIn = !!user;
    loginForm.classList.toggle('hidden', loggedIn);
    loggedInStatus.classList.toggle('hidden', !loggedIn);
    gameManagementSection.classList.toggle('hidden', !loggedIn);
    setBulkLoading(false);
    if (user) {
      userEmailSpan.textContent = user.email;
      fetchOwnedGames(user.uid);
      if (isSignupMode) toggleSignupModeUI(false);
    } else {
      userEmailSpan.textContent = '';
      ownedGamesListDiv.innerHTML = '<p>Please log in to see your games.</p>';
      ownedGamesCountSpan.textContent = '0';
      clearUpdateForm(); clearRegisterForm();
    }
  });

  toggleSignupLink.addEventListener('click', (e) => { e.preventDefault(); toggleSignupModeUI(!isSignupMode); });

  signupButton.addEventListener('click', async () => {
      const email = emailInput.value.trim(); const password = passwordInput.value; const confirmPassword = confirmPasswordInput.value;
      hideStatus(authStatus);
      if (!email || !password || !confirmPassword) { showStatus(authStatus, 'Please fill all fields.', 'error'); return; }
      if (password !== confirmPassword) { showStatus(authStatus, 'Passwords do not match.', 'error'); return; }
      if (password.length < 6) { showStatus(authStatus, 'Password too weak.', 'error'); return; }
      setLoading(signupButton, true, 'Sign Up');
      try { await createUserWithEmailAndPassword(auth, email, password); clearAuthInputs(); }
      catch (error) { console.error("Signup Error:", error); showStatus(authStatus, getAuthErrorMessage(error), 'error'); setLoading(signupButton, false); }
  });

  loginButton.addEventListener('click', async () => {
      const email = emailInput.value.trim(); const password = passwordInput.value;
      hideStatus(authStatus);
      if (!email || !password) { showStatus(authStatus, 'Enter email/password.', 'error'); return; }
      setLoading(loginButton, true, 'Login');
      try { await signInWithEmailAndPassword(auth, email, password); clearAuthInputs(); }
      catch (error) { console.error("Login Error:", error); showStatus(authStatus, getAuthErrorMessage(error), 'error'); setLoading(loginButton, false); }
  });

  logoutButton.addEventListener('click', async () => {
      setBulkLoading(true); hideStatus(authStatus);
      try { await signOut(auth); }
      catch (error) { console.error("Logout Error:", error); showStatus(authStatus, `Logout Error: ${error.message}`, 'error'); setBulkLoading(false); }
  });

  forgotPasswordButton.addEventListener('click', async () => {
       const email = emailInput.value.trim(); hideStatus(authStatus);
       if (!email) { showStatus(authStatus, 'Enter email first.', 'info'); return; }
       setLoading(forgotPasswordButton, true, 'Forgot Password?');
       try { await sendPasswordResetEmail(auth, email); showStatus(authStatus, `Password reset email sent to ${email}.`, 'success', 10000); }
       catch (error) { console.error("PW Reset Error:", error); showStatus(authStatus, getAuthErrorMessage(error), 'error'); }
       finally { setLoading(forgotPasswordButton, false); }
   });

   async function fetchOwnedGames(userId) {
        ownedGamesListDiv.innerHTML = '<p><i>Loading your games...</i></p>'; ownedGamesCountSpan.textContent = '-';
        const userGamesQuery = query(gamesRef, orderByChild('ownerUid'), equalTo(userId));
        try {
            const snapshot = await get(userGamesQuery); let count = 0;
            if (snapshot.exists()) {
                let gamesHtml = '<ul>';
                snapshot.forEach((childSnapshot) => {
                    count++; const gameId = childSnapshot.key; const gameData = childSnapshot.val();
                    gamesHtml += `<li>
                                    <div>
                                        <code>${gameId}</code>
                                        <small>Ver: <strong>${gameData.currentVersion || 'N/A'}</strong></small>
                                    </div>
                                    <button class="select-game-btn" data-gameid="${gameId}" title="Use this ID for update form">Use ID</button>
                                 </li>`;
                });
                gamesHtml += '</ul>'; ownedGamesListDiv.innerHTML = gamesHtml; ownedGamesCountSpan.textContent = count;
                document.querySelectorAll('.select-game-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const selectedId = button.dataset.gameid; updateGameIdInput.value = selectedId;
                        showStatus(selectGameStatus, `Selected: ${selectedId}. Enter new version.`, 'info', 4000);
                        updateGameIdInput.focus(); updateGameIdInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                });
            } else { ownedGamesListDiv.innerHTML = '<p>No games registered yet.</p>'; ownedGamesCountSpan.textContent = '0'; }
        } catch (error) {
             console.error("Error fetching owned games:", error);
             ownedGamesListDiv.innerHTML = `<p class="error">Error loading games: ${error.message}. Ensure DB rules allow querying games by ownerUid.</p>`;
             ownedGamesCountSpan.textContent = '?';
             showStatus(registerStatus, `Error loading games: ${error.message}`, 'error');
        }
    }

    registerButton.addEventListener('click', async () => {
        const gameId = registerGameIdInput.value.trim(); const user = auth.currentUser; clearAllStatus();
        if (!/^\d+$/.test(gameId)) { showStatus(registerStatus, 'Game ID must be numeric.', 'error'); return; }
        if (!user) { showStatus(registerStatus, 'Not logged in.', 'error'); return; }
        const specificGameRef = ref(db, 'games/' + gameId);
        const initialVersion = "0.0.1";
        setLoading(registerButton, true, 'Register This ID');
        try {
            const { committed } = await runTransaction(specificGameRef, (currentData) => {
                if (currentData === null) { return { ownerUid: user.uid, email: user.email, currentVersion: initialVersion }; }
                else { return; }
            });
            if (committed) { showStatus(registerStatus, `Success! Game ID ${gameId} registered.`, 'success'); clearRegisterForm(); fetchOwnedGames(user.uid); }
            else { showStatus(registerStatus, `Game ID ${gameId} already registered.`, 'error'); }
        } catch (error) { console.error("Reg Error:", error); showStatus(registerStatus, `Registration failed: ${error.message}.`, 'error'); }
        finally { setLoading(registerButton, false); }
    });

    updateButton.addEventListener('click', async () => {
        const gameId = updateGameIdInput.value.trim(); const newVersion = newVersionInput.value.trim(); const user = auth.currentUser; clearAllStatus();
        if (!/^\d+$/.test(gameId)) { showStatus(updateStatus, 'Game ID must be numeric.', 'error'); return; }
        if (!newVersion) { showStatus(updateStatus, 'New Version required.', 'error'); return; }
        if (!user) { showStatus(updateStatus, 'Not logged in.', 'error'); return; }
        const gameRef = ref(db, `games/${gameId}`);
        const versionRef = child(gameRef, 'currentVersion');
        const ownerRef = child(gameRef, 'ownerUid');
        setLoading(updateButton, true, 'Set New Version');
        try {
            const ownerSnapshot = await get(ownerRef);
            if (!ownerSnapshot.exists() || ownerSnapshot.val() !== user.uid) {
                showStatus(updateStatus, `Cannot update: Game ID ${gameId} not found or not owned.`, 'error');
                setLoading(updateButton, false); return;
            }
            await set(versionRef, newVersion);
            showStatus(updateStatus, `Success! Game ID ${gameId} updated to "${newVersion}".`, 'success');
            clearUpdateForm(); fetchOwnedGames(user.uid);
        } catch (error) { console.error("Update Error:", error); showStatus(updateStatus, `Update failed: ${error.message}.`, 'error'); }
        finally { setLoading(updateButton, false); }
    });

  toggleSignupModeUI(false);

</script>

</body>
</html>
